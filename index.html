<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Schedule Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; display: flex; justify-content: center; }
      .container { max-width: 800px; width: 100%; }
      .screen { display: none; }
      .week-header-row, .week-data-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
      .day { text-align: center; }
      .day-header { font-weight: bold; font-size: 0.9em; color: #555; padding-bottom: 5px; }
      .day-label { font-size: 0.8em; color: #555; }
      .day-header.sunday, .day.sunday .day-label { color: red; }
      .day-header.saturday, .day.saturday .day-label { color: blue; }
      select, button { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
      button { color: white; background-color: #0d6efd; border: none; cursor: pointer; margin-top: 10px; font-weight: 500; }
      button:disabled { background-color: #9E9E9E; }
      #status { margin-top: 15px; text-align: center; font-weight: bold; }
      .auth-button { background-color: #4285F4; }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
  </head>
  <body>
    <div class="container">
      <h2>Schedule Input Assistant</h2>
      
      <div id="auth-screen" class="screen">
        <p>Please sign in with your Google account to authorize calendar access.</p>
        <button id="auth-button" class="auth-button" onclick="handleAuthClick()">Authorize with Google</button>
      </div>

      <div id="schedule-grid-screen" class="screen">
        <p>
          <select id="calendar-select" style="max-width: 300px;"></select>
        </p>
        <div class="week-header-row">
          <div class="day-header sunday">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header saturday">Sat</div>
        </div>
        <div id="schedule-grid"></div>
        <button id="submit-button" onclick="handleFormSubmit()">Create Events</button>
      </div>

      <div id="status"></div>
    </div>

    <script>
      // --- PASTE YOUR GOOGLE CLOUD CLIENT ID HERE ---
      const CLIENT_ID = 'YOUR_GCP_OAUTH_CLIENT_ID_HERE.apps.googleusercontent.com';

      // --- PASTE YOUR CLOUD FUNCTION URLS HERE ---
      const GET_CALENDARS_URL = 'YOUR_GET_CALENDARS_FUNCTION_URL';
      const CREATE_EVENTS_URL = 'YOUR_CREATE_EVENTS_FUNCTION_URL';

      const SCOPES = 'https://www.googleapis.com/auth/calendar'; // Use broader scope for calendarList.list
      let tokenClient;

      window.onload = function() {
        gapi.load('client', initializeGapiClient);
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // Will be defined dynamically
        });
        showScreen('auth-screen');
      };
      
      async function initializeGapiClient() {
        await gapi.client.init({
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
        });
      }

      function handleAuthClick() {
        tokenClient.callback = async (tokenResponse) => {
          if (tokenResponse.error !== undefined) {
            throw (tokenResponse);
          }
          // The gapi client needs the token to be set
          gapi.client.setToken(tokenResponse);
          await getCalendarList();
        };

        // If the user has already granted consent, the popup won't appear.
        // If it's the first time, they will see the consent screen.
        tokenClient.requestAccessToken({prompt: ''});
      }

      async function getCalendarList() {
        showStatus('Loading your calendars...');
        try {
          const response = await gapi.client.calendar.calendarList.list();
          const calendars = response.result.items.filter(cal => cal.accessRole === 'writer' || cal.accessRole === 'owner');
          populateCalendarSelect(calendars);
          buildScheduleGrid();
          showScreen('schedule-grid-screen');
          showStatus('');
        } catch (err) {
          showStatus(`Error loading calendars: ${err.result.error.message}`, 'red');
        }
      }

      async function handleFormSubmit() {
        disableButton('submit-button', true);
        showStatus('Creating events...');
        
        const formObject = { calendarId: document.getElementById('calendar-select').value };
        document.querySelectorAll('#schedule-grid select').forEach(select => {
          if (select.value !== 'NONE') {
            formObject[select.name] = select.value;
          }
        });
        
        const token = gapi.client.getToken();
        if (!token) {
            onFailure({message: "Authentication token is missing. Please re-authenticate."});
            return;
        }

        try {
            const response = await fetch(CREATE_EVENTS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token.access_token}`
                },
                body: JSON.stringify({ formObject: formObject })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'An unknown error occurred.');
            }
            onSuccess(result.message);
        } catch (error) {
            onFailure(error);
        }
      }
      
      // --- The rest of your UI helper functions (populateCalendarSelect, buildScheduleGrid, etc.) remain the same ---
      // ... (copy them from your existing file if you made custom changes, otherwise these are fine)
      function populateCalendarSelect(calendars) { /* ... */ }
      function buildScheduleGrid() { /* ... */ }
      function onSuccess(message) { /* ... */ }
      function onFailure(error) { /* ... */ }
      function showScreen(screenId) { /* ... */ }
      function disableButton(buttonId, disabled) { /* ... */ }
    </script>
  </body>
</html>