<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Schedule Assistant</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; display: flex; justify-content: center; }
      .container { max-width: 800px; width: 100%; }
      .screen { display: none; }
      .week-header-row, .week-data-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
      .day { text-align: center; }
      .day-header { font-weight: bold; font-size: 0.9em; color: #555; padding-bottom: 5px; }
      .day-label { font-size: 0.8em; color: #555; }
      .day-header.sunday, .day.sunday .day-label { color: red; }
      .day-header.saturday, .day.saturday .day-label { color: blue; }
      select, button { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
      button { color: white; background-color: #0d6efd; border: none; cursor: pointer; margin-top: 10px; font-weight: 500; }
      button:disabled { background-color: #9E9E9E; }
      #status { margin-top: 15px; text-align: center; font-weight: bold; }
      .auth-button { background-color: #4285F4; }
      .change-link { font-size: 0.8em; text-decoration: underline; color: #1a73e8; cursor: pointer; }
    </style>
    <script src="https://accounts.google.com/gsi/client" onload="gsiLoaded()" async defer></script>
  </head>
  <body>
    <div class="container">
      <h2>Schedule Assistant for Google Calendar</h2>
      
      <div id="auth-screen" class="screen">
        <p>Please sign in with your Google account to authorize calendar access.</p>
        <button id="auth-button" class="auth-button" onclick="handleAuthClick()">Authorize with Google</button>
      </div>

      <div id="schedule-grid-screen" class="screen">
        <p>
          <select id="calendar-select" style="max-width: 300px;"></select>
          <span class="change-link" onclick="changeCalendar()">Change</span>
        </p>
        <div class="week-header-row">
          <div class="day-header sunday">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header saturday">Sat</div>
        </div>
        <div id="schedule-grid"></div>
        <button id="submit-button" onclick="handleFormSubmit()">Create Events</button>
      </div>

      <div id="status"></div>
    </div>

    <script>
      // --- PASTE YOUR GOOGLE CLOUD CLIENT ID HERE ---
      const CLIENT_ID = '377649002021-agr0pdmlbcgpc5auikjglk2in0afcis4.apps.googleusercontent.com';

      // --- PASTE YOUR CLOUD FUNCTION URLS HERE ---
      const GET_SHIFTS_URL = 'https://g-schedule.vercel.app/api/get-shifts';
      const GET_CALENDARS_URL = 'https://g-schedule.vercel.app/api/get-calendars';
      const CREATE_EVENTS_URL = 'https://g-schedule.vercel.app/api/create-events';

      const SCOPES = 'https://www.googleapis.com/auth/calendar';
      let tokenClient;
      let scheduleDates =[];

      /**
       * This function is called automatically by the Google script tag once it has fully loaded.
       */
      function gsiLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: handleTokenResponse,
        });
        
        const storedToken = getStoredToken();
        if (storedToken) {
          getCalendarList(storedToken);
        } else {
          showScreen('auth-screen');
        }
      }

      function handleAuthClick() {
        tokenClient.requestAccessToken({prompt: 'consent'});
      }
      
      function handleTokenResponse(tokenResponse) {
        if (tokenResponse.error !== undefined) {
          onFailure({ message: `Auth error: ${tokenResponse.error}` });
          return;
        }
        const expires_at = Date.now() + (parseInt(tokenResponse.expires_in) * 1000);
        localStorage.setItem('google_auth_token', JSON.stringify({
          access_token: tokenResponse.access_token,
          expires_at: expires_at
        }));
        
        getCalendarList(tokenResponse.access_token);
      }

      function getStoredToken() {
        const tokenString = localStorage.getItem('google_auth_token');
        if (!tokenString) return null;
        
        const tokenData = JSON.parse(tokenString);
        if (Date.now() > tokenData.expires_at - 60000) {
          localStorage.removeItem('google_auth_token');
          return null;
        }
        return tokenData.access_token;
      }
      
      async function getCalendarList(accessToken) {
        showStatus('Loading your calendars...');
        try {
          const response = await fetch(GET_CALENDARS_URL, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          const calendars = await response.json();
          if (!response.ok) throw new Error(calendars.message);

          populateCalendarSelect(calendars);
          
          // After populating calendars, get the existing shifts
          await getExistingShifts(accessToken);

          buildScheduleGrid();
          showScreen('schedule-grid-screen');
          showStatus('');
        } catch (err) {
          onFailure(err);
        }
      }

      async function getExistingShifts(accessToken) {
        showStatus('Loading existing schedule...');
        const today = new Date();
        const daysUntilSunday = (7 - today.getDay()) % 7;
        const startDate = new Date();
        startDate.setDate(today.getDate() + daysUntilSunday);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 42);

        const response = await fetch(GET_SHIFTS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
            body: JSON.stringify({
                calendarId: document.getElementById('calendar-select').value,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            })
        });
        const existingShifts = await response.json();
        if (!response.ok) throw new Error(existingShifts.message);
        
        // Populate the grid with existing shifts
        for (const dateKey in existingShifts) {
            const select = document.getElementById(`shift_${dateKey}`);
            if (select) {
                select.value = existingShifts[dateKey];
            }
        }
      }

      function buildScheduleGrid() {
        const gridDiv = document.getElementById('schedule-grid');
        let html = '';
        const today = new Date();
        const daysUntilSunday = (7 - today.getDay()) % 7;
        const startDate = new Date();
        startDate.setDate(today.getDate() + daysUntilSunday);

        scheduleDates = []; // Clear and repopulate global dates
        for (let i = 0; i < 42; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          scheduleDates.push(currentDate);
        }

        for (let i = 0; i < scheduleDates.length; i += 7) {
          const weekDates = scheduleDates.slice(i, i + 7);
          html += '<div class="week-data-row">';
          weekDates.forEach((currentDate, index) => {
            const isoString = currentDate.toISOString().split('T')[0];
            const month = currentDate.toLocaleString('en-US', { month: 'short' });
            const day = currentDate.getDate();
            let displayLabel = `${day}`;
            if (i === 0 && index === 0 || day === 1) displayLabel = `${month} ${day}`;
            const isSunday = (index === 0);
            const isSaturday = (index === 6);
            let dayClasses = ['day'];
            if (isSunday) dayClasses.push('sunday');
            if (isSaturday) dayClasses.push('saturday');
            html += `<div class="${dayClasses.join(' ')}"><div class="day-label">${displayLabel}</div><select id="shift_${isoString}" name="shift_${isoString}"><option value="NONE"> </option><option value="W">W</option><option value="C1">C1</option><option value="C2">C2</option></select></div>`;
          });
          html += '</div>';
        }
        gridDiv.innerHTML = html;
      }

      async function handleFormSubmit() {
        disableButton('submit-button', true);
        showStatus('Syncing schedule...');
        
        const formObject = { calendarId: document.getElementById('calendar-select').value };
        document.querySelectorAll('#schedule-grid select').forEach(select => {
            formObject[select.id] = select.value;
        });
        
        const accessToken = getStoredToken();
        if (!accessToken) {
            onFailure({message: "Session expired. Please re-authorize."});
            return;
        }

        const dateRange = {
            start: scheduleDates[0].toISOString(),
            end: new Date(scheduleDates[41].getTime() + 86400000).toISOString() // End of the last day
        };

        try {
            const response = await fetch(CREATE_EVENTS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                body: JSON.stringify({ formObject, dateRange })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            onSuccess(result.message);
        } catch (error) {
            onFailure(error);
        }
      }

      // --- UI Helper Functions ---
      // This entire block of functions must be present in your script.
      function populateCalendarSelect(calendars) {
        const select = document.getElementById('calendar-select');
        select.innerHTML = '';
        calendars.forEach(cal => {
          const option = document.createElement('option');
          option.value = cal.id;
          option.textContent = cal.summary;
          select.appendChild(option);
        });
      }

      function buildScheduleGrid() {
        const gridDiv = document.getElementById('schedule-grid');
        let html = '';
        const today = new Date();
        const daysUntilSunday = (7 - today.getDay()) % 7;
        const startDate = new Date();
        startDate.setDate(today.getDate() + daysUntilSunday);

        for (let i = 0; i < 42; i++) {
          if (i % 7 === 0) html += '<div class="week-data-row">';
          
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          
          const isoString = currentDate.toISOString().split('T')[0];
          const month = currentDate.toLocaleString('en-US', { month: 'short' });
          const day = currentDate.getDate();

          let displayLabel = `${day}`;
          if (i === 0 || day === 1) {
              displayLabel = `${month} ${day}`;
          }
          
          const isSunday = (i % 7) === 0;
          const isSaturday = (i % 7) === 6;
          let dayClasses = ['day'];
          if (isSunday) dayClasses.push('sunday');
          if (isSaturday) dayClasses.push('saturday');

          html += `<div class="${dayClasses.join(' ')}"><div class="day-label">${displayLabel}</div>
                   <select name="shift_${isoString}"><option value="NONE"> </option><option value="W">W</option><option value="C1">C1</option><option value="C2">C2</option></select></div>`;

          if (i % 7 === 6) html += '</div>';
        }
        gridDiv.innerHTML = html;
      }
      
      function onSuccess(message) {
        disableButton('submit-button', false);
        showStatus(message, 'green');
      }

      function onFailure(error) {
        disableButton('submit-button', false);
        showStatus(`Error: ${error.message}`, 'red');
      }
      
      function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'block';
      }

      function showStatus(message, color = 'black') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.style.color = color;
      }

      function disableButton(buttonId, disabled) {
         document.getElementById(buttonId).disabled = disabled;
      }
    </script>
  </body>
</html>