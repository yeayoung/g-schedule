<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Schedule Assistant</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; display: flex; justify-content: center; }
      .container { max-width: 800px; width: 100%; }
      .screen { display: none; }
      
      /* Grid Layout */
      .week-header-row, .week-data-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px; }
      
      /* Day Box Styling */
      .day { 
        text-align: center; 
        border-radius: 6px; 
        padding: 4px 2px;
        border: 1px solid #e0e0e0;
        background-color: white; 
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 50px;
      }

      /* --- COLOR CODING CLASSES --- */
      
      /* Work Shift (W) - Lighter Pink/Magenta */
      .day.bg-w { background-color: #ff80ab; border-color: #ff4081; } 
      /* Work & Call 1 (C1) - Deep Burgundy */
      .day.bg-c1 { background-color: #880e4f; border-color: #880e4f; } 
      /* Work & Call 2 (C2) - Dark Raspberry */
      .day.bg-c2 { background-color: #ad1457; border-color: #ad1457; } 

      /* Call 1 Only (C1O) - Deep Purple */
      .day.bg-c1o { background-color: #311b92; border-color: #311b92; }
      /* Call 2 Only (C2O) - Standard Purple */
      .day.bg-c2o { background-color: #6a1b9a; border-color: #6a1b9a; }

      /* --- TEXT COLORS --- */
      /* White text for dark backgrounds (WC1, WC2, C1O, C2O) */
      .day.bg-c1 .day-label, .day.bg-c1 select, 
      .day.bg-c2 .day-label, .day.bg-c2 select,
      .day.bg-c1o .day-label, .day.bg-c1o select,
      .day.bg-c2o .day-label, .day.bg-c2o select { 
          color: #ffffff !important; 
          font-weight: 500;
      }
      
      /* Black text for lighter backgrounds (Work) */
      .day.bg-w .day-label, .day.bg-w select { 
          color: #000000 !important; 
          font-weight: 500;
      }

      .day-header { font-weight: bold; font-size: 0.8em; color: #555; padding-bottom: 5px; text-align: center; }
      .day-label { font-size: 0.75em; color: #555; margin-bottom: 2px; font-weight: 600;}
      
      .day-header.sunday, .day.sunday .day-label { color: #d32f2f; }
      .day-header.saturday, .day.saturday .day-label { color: #1976d2; }
      
      /* Specific override for white text on dark backgrounds */
      .day.bg-c1 .day-label, .day.bg-c2 .day-label,
      .day.bg-c1o .day-label, .day.bg-c2o .day-label { color: white !important; }

      /* Select Box Styling - Smaller for Mobile */
      select { 
        width: 100%; 
        padding: 2px; 
        font-size: 11px;
        border-radius: 4px; 
        border: 1px solid #ccc; 
        box-sizing: border-box; 
        background-color: rgba(255,255,255,0.9);
        color: #333;
        height: 24px;
      }
      
      /* Main Dropdown and Buttons */
      #calendar-select { 
          padding: 10px; 
          font-size: 16px; 
          width: 100%; 
          height: auto; /* Fixes the 'empty box' bug */
          margin-bottom: 10px;
      }

      /* --- NEW WEEK SELECTION TOOLBAR --- */
      .week-selection-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
      }
      .week-selection-title {
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 8px;
        color: #555;
      }
      .week-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .week-option {
        display: flex;
        align-items: center;
        font-size: 0.85em;
        background: #f1f3f4;
        padding: 5px 10px;
        border-radius: 15px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      .week-option:hover { background-color: #e0e0e0; }
      .week-option.selected {
        background-color: #e8f0fe;
        border-color: #1967d2;
        color: #1967d2;
        font-weight: 600;
      }
      .week-option input { display: none; } /* Hide actual checkbox */

      button { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; margin-top: 10px; font-weight: 500; color: white; background-color: #0d6efd; }
      button:disabled { background-color: #9E9E9E; }
      #status { margin-top: 15px; text-align: center; font-weight: bold; }
      .auth-button { background-color: #4285F4; }
    </style>
    <script src="https://accounts.google.com/gsi/client" onload="gsiLoaded()" async defer></script>
  </head>
  <body>
    <div class="container">
      <h2>Schedule Assistant</h2>
      
      <div id="auth-screen" class="screen">
        <p>Please sign in with your Google account to authorize calendar access.</p>
        <button id="auth-button" class="auth-button" onclick="handleAuthClick()">Authorize with Google</button>
      </div>

      <div id="schedule-grid-screen" class="screen">
        <p>
          <select id="calendar-select" onchange="calendarSelectionChanged()"></select>
        </p>

        <div id="week-selection" class="week-selection-container">
            <div class="week-selection-title">Select weeks to sync (Max 4):</div>
            <div class="week-checkboxes" id="week-checkboxes"></div>
        </div>

        <div class="week-header-row">
          <div class="day-header sunday">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header saturday">Sat</div>
        </div>
        <div id="schedule-grid"></div>
        <button id="submit-button" onclick="handleFormSubmit()">Save Schedule</button>
      </div>

      <div id="status"></div>
    </div>

    <script>
      const GET_CALENDARS_URL = '/api/get-calendars';
      const GET_SHIFTS_URL = '/api/get-shifts';
      const CREATE_EVENTS_URL = '/api/create-events';

      // --- PASTE YOUR REAL CLIENT ID HERE ---
      const CLIENT_ID = '377649002021-agr0pdmlbcgpc5auikjglk2in0afcis4.apps.googleusercontent.com';

      const SCOPES = 'https://www.googleapis.com/auth/calendar';
      const TOTAL_WEEKS_ZOOM = 6; 
      
      let tokenClient;
      let scheduleDates = [];

      function gsiLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: handleTokenResponse,
        });
        
        const storedToken = getStoredToken();
        if (storedToken) {
          getCalendarList(storedToken);
        } else {
          showScreen('auth-screen');
        }
      }

      function handleAuthClick() {
        tokenClient.requestAccessToken({prompt: 'consent'});
      }
      
      function handleTokenResponse(tokenResponse) {
        if (tokenResponse.error !== undefined) {
          onFailure({ message: `Auth error: ${tokenResponse.error}` });
          return;
        }
        const expires_at = Date.now() + (parseInt(tokenResponse.expires_in) * 1000);
        localStorage.setItem('google_auth_token', JSON.stringify({
          access_token: tokenResponse.access_token,
          expires_at: expires_at
        }));
        getCalendarList(tokenResponse.access_token);
      }

      function getStoredToken() {
        const tokenString = localStorage.getItem('google_auth_token');
        if (!tokenString) return null;
        
        const tokenData = JSON.parse(tokenString);
        if (Date.now() > tokenData.expires_at - 60000) {
          localStorage.removeItem('google_auth_token');
          return null;
        }
        return tokenData.access_token;
      }
      
      async function getCalendarList(accessToken) {
        showStatus('Loading your calendars...');
        try {
          const response = await fetch(GET_CALENDARS_URL, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          const calendars = await response.json();
          if (!response.ok) throw new Error(calendars.message);

          populateCalendarSelect(calendars);
          buildScheduleGrid(); // This now also builds the checkboxes
          await getExistingShifts(accessToken);
          
          showScreen('schedule-grid-screen');
          showStatus('');
        } catch (err) {
          onFailure(err);
        }
      }
      
      async function getExistingShifts(accessToken) {
        showStatus('Loading existing schedule...');
        try {
            // Reset all selects
            document.querySelectorAll('#schedule-grid select').forEach(select => {
                select.value = 'NONE';
                updateColor(select); 
            });
            
            const response = await fetch(GET_SHIFTS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                body: JSON.stringify({
                    calendarId: document.getElementById('calendar-select').value,
                })
            });
            const existingShifts = await response.json();
            if (!response.ok) throw new Error(existingShifts.message);
            
            // Populate grid
            for (const dateKey in existingShifts) {
                const select = document.getElementById(`shift_${dateKey}`);
                if (select) {
                    select.value = existingShifts[dateKey];
                    updateColor(select); 
                }
            }

            // --- SMART DEFAULT LOGIC FOR CHECKBOXES ---
            const allChecks = document.querySelectorAll('#week-checkboxes input');
            let autoCheckedCount = 0;

            allChecks.forEach((checkbox,WB, index) => {
                const weekStartIndex = index * 7;
                // Check if this week is empty
                let hasShifts = false;
                for(let d = 0; d < 7; d++) {
                    // Safe check if scheduleDates element exists
                    if (scheduleDates[weekStartIndex + d]) {
                        const dateObj = scheduleDates[weekStartIndex + d];
                        const year = dateObj.getFullYear();
                        const mo = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const da = String(dateObj.getDate()).padStart(2, '0');
                        const iso = `${year}-${mo}-${da}`;

                        if (existingShifts[iso] && existingShifts[iso] !== 'NONE') {
                            hasShifts = true;
                            break;
                        }
                    }
                }
                
                // If empty and we haven't hit the limit of 4, check it
                if (!hasShifts && autoCheckedCount < 4) {
                    checkbox.checked = true;
                    checkbox.parentElement.classList.add('selected');
                    autoCheckedCount++;
                } else {
                    checkbox.checked = false;
                    checkbox.parentElement.classList.remove('selected');
                }
            });

        } catch (err) {
            onFailure(err);
        }
      }

      async function calendarSelectionChanged() {
        const newCalendarId = document.getElementById('calendar-select').value;
        localStorage.setItem('targetCalendarId', newCalendarId);
        
        const accessToken = getStoredToken();
        if (!accessToken) {
            onFailure({message: "Session expired. Please re-authorize."});
            return;
        }
        
        await getExistingShifts(accessToken);
        showStatus('Schedule updated for the selected calendar.');
        setTimeout(() => showStatus(''), 2000);
      }

      function handleFormSubmit() {
        const checkboxes = document.querySelectorAll('#week-checkboxes input:checked');
        if (checkboxes.length === 0) {
            showStatus("Please select at least one week to sync.", "red");
            return;
        }

        disableButton('submit-button', true);
        showStatus('Syncing selected weeks...');
        
        // Calculate the specific date ranges
        const ranges = [];
        checkboxes.forEach(cb => {
            const index = parseInt(cb.value);
            const start = scheduleDates[index]; 
            const end = scheduleDates[index + 6]; 
            
            const sStr = start.getFullYear() + '-' + String(start.getMonth()+1).padStart(2,'0') + '-' + String(start.getDate()).padStart(2,'0');
            const eStr = end.getFullYear() + '-' + String(end.getMonth()+1).padStart(2,'0') + '-' + String(end.getDate()).padStart(2,'0');
            
            ranges.push({ start: sStr, end: eStr });
        });

        const formObject = { calendarId: document.getElementById('calendar-select').value };
        document.querySelectorAll('#schedule-grid select').forEach(select => {
            formObject[select.id] = select.value;
        });
        
        const accessToken = getStoredToken();
        if (!accessToken) {
            onFailure({message: "Session expired. Please re-authorize."});
            disableButton('submit-button', false);
            return;
        }

        fetch(CREATE_EVENTS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
            body: JSON.stringify({ formObject, ranges })
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (!ok) throw new Error(data.message);
            onSuccess(data.message);
        })
        .catch(onFailure);
      }
      
      // --- UI Helper Functions ---
      
      function updateColor(selectElement) {
        const dayDiv = selectElement.parentElement;
        const value = selectElement.value;
        
        dayDiv.classList.remove('bg-w', 'bg-c1', 'bg-c2', 'bg-c1o', 'bg-c2o');
        
        if (value === 'W') dayDiv.classList.add('bg-w');
        else if (value === 'C1') dayDiv.classList.add('bg-c1');
        else if (value === 'C2') dayDiv.classList.add('bg-c2');
        else if (value === 'C1O') dayDiv.classList.add('bg-c1o');
        else if (value === 'C2O') dayDiv.classList.add('bg-c2o');
      }

      function populateCalendarSelect(calendars) {
        const select = document.getElementById('calendar-select');
        select.innerHTML = '';
        calendars.forEach(cal => {
          const option = document.createElement('option');
          option.value = cal.id;
          option.textContent = cal.summary;
          select.appendChild(option);
        });
        
        const savedId = localStorage.getItem('targetCalendarId');
        const exists = calendars.some(cal => cal.id === savedId);

        if (savedId && exists) {
            select.value = savedId;
        } else if (calendars.length > 0) {
            select.value = calendars[0].id;
        }
        
        // Don't trigger 'calendarSelectionChanged' here to avoid double-loading,
        // because getCalendarList calls getExistingShifts immediately after.
      }

      function buildScheduleGrid() {
        const gridDiv = document.getElementById('schedule-grid');
        let html = '';
        const today = new Date();
        
        const dayOfWeek = today.getDay(); 
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - dayOfWeek); 

        scheduleDates = [];
        for (let i = 0; i < (TOTAL_WEEKS_ZOOM * 7); i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          scheduleDates.push(currentDate);
        }

        for (let i = 0; i < scheduleDates.length; i += 7) {
          const weekDates = scheduleDates.slice(i, i + 7);
          html += '<div class="week-data-row">';
          weekDates.forEach((currentDate, index) => {
            const year = currentDate.getFullYear();
            const mo = String(currentDate.getMonth() + 1).padStart(2, '0');
            const da = String(currentDate.getDate()).padStart(2, '0');
            const isoString = `${year}-${mo}-${da}`;

            const monthName = currentDate.toLocaleString('en-US', { month: 'short' });
            const dayNum = currentDate.getDate();
            let displayLabel = `${dayNum}`;
            
            if ((i === 0 && index === 0) || dayNum === 1) {
                displayLabel = `${monthName} ${dayNum}`;
            }

            const isSunday = (index === 0);
            const isSaturday = (index === 6);
            let dayClasses = ['day'];
            if (isSunday) dayClasses.push('sunday');
            if (isSaturday) dayClasses.push('saturday');
            
            html += `
            <div class="${dayClasses.join(' ')}">
                <div class="day-label">${displayLabel}</div>
                <select id="shift_${isoString}" name="shift_${isoString}" onchange="updateColor(this)">
                    <option value="NONE" style="color:black;">-</option>
                    <option value="W" title="Work Shift" style="color:black;">Work</option>
                    <option value="C1" title="Work & Call 1" style="color:black;">WC1</option>
                    <option value="C2" title="Work & Call 2" style="color:black;">WC2</option>
                    <option value="C1O" title="Call 1 Only" style="color:black;">Call 1</option>
                    <option value="C2O" title="Call 2 Only" style="color:black;">Call 2</option>
                </select>
            </div>`;
          });
          html += '</div>';
        }
        
        // --- THIS WAS LIKELY MISSING BEFORE ---
        renderWeekSelection(scheduleDates);
        
        gridDiv.innerHTML = html;
      }

      function renderWeekSelection(dates) {
          const container = document.getElementById('week-checkboxes');
          if (!container) return; // safety
          container.innerHTML = '';
          
          for (let i = 0; i < dates.length; i += 7) {
              const weekStart = dates[i];
              const dateStr = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              
              const label = document.createElement('label');
              label.className = 'week-option';
              label.id = `week-label-${i/7}`;
              
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = i; 
              checkbox.onchange = (e) => handleWeekSelection(e.target);
              
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(`Week of ${dateStr}`));
              container.appendChild(label);
          }
      }

      function handleWeekSelection(checkbox) {
          const allChecks = document.querySelectorAll('#week-checkboxes input');
          const checkedCount = Array.from(allChecks).filter(c => c.checked).length;
          
          if (checkedCount > 4 && checkbox.checked) {
              checkbox.checked = false; 
              showStatus("You can only sync 4 weeks at a time.", "orange");
              setTimeout(() => showStatus(""), 2000);
          }
          
          const label = checkbox.parentElement;
          if (checkbox.checked) label.classList.add('selected');
          else label.classList.remove('selected');
      }

      function onSuccess(message) {
        disableButton('submit-button', false);
        showStatus(message, 'green');
      }

      function onFailure(error) {
        disableButton('submit-button', false);
        showStatus(`Error: ${error.message || error}`, 'red');
      }
      
      function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'block';
      }

      function showStatus(message, color = 'black') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.style.color = color;
      }

      function disableButton(buttonId, disabled) {
         document.getElementById(buttonId).disabled = disabled;
      }
    </script>
  </body>
</html>